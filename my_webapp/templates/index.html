<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class', theme: { extend: { colors: { tg_bg: 'var(--tg-theme-bg-color)', tg_text: 'var(--tg-theme-text-color)' } } } }</script>
    <style> body { background: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); } .card { background: var(--tg-theme-secondary-bg-color, #f5f5f5); } </style>
</head>
<body class="transition-colors duration-200">
    <div id="app" class="p-4 pb-24 max-w-md mx-auto relative min-h-screen">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Tasks v3.0</h1>
            <div class="flex gap-2 items-center">
                <button onclick="openNewsModal()" class="text-xl p-1 relative">üì¢ <span id="newsDot" class="hidden absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span></button>
                <button id="usersBtn" onclick="openUsersModal()" class="hidden px-2 py-1 bg-purple-100 text-purple-700 rounded dark:bg-purple-900 dark:text-purple-200 text-sm">üë•</button>
                <div id="userRole" class="text-sm font-medium px-2 py-1 rounded bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">...</div>
            </div>
        </header>
        <div id="filterContainer" class="hidden flex gap-2 mb-4">
            <button onclick="loadTasks('all')" class="flex-1 py-2 px-4 rounded bg-gray-200 dark:bg-gray-700 text-sm">–í—Å–µ</button>
            <button onclick="loadTasks('mine')" class="flex-1 py-2 px-4 rounded bg-gray-200 dark:bg-gray-700 text-sm">–ú–æ–∏</button>
        </div>
        <div id="taskList" class="space-y-3"><div class="text-center mt-10 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
        <button id="fab" onclick="openModal()" class="hidden fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg text-3xl pb-1">+</button>
    </div>

    <!-- Task Modal -->
    <div id="modal" class="fixed inset-0 bg-black/50 hidden flex items-end justify-center sm:items-center z-50 opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-gray-800 w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 transform transition-transform duration-300 translate-y-full sm:translate-y-0" id="modalContent">
            <h2 id="modalTitle" class="text-xl font-bold mb-4">–ó–∞–¥–∞—á–∞</h2>
            <form id="taskForm" onsubmit="handleFormSubmit(event)">
                <div class="mb-3"><label class="text-xs">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="inpTitle" class="w-full p-2 rounded border dark:bg-gray-700" required></div>
                <div class="mb-3"><label class="text-xs">–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="inpDesc" class="w-full p-2 rounded border dark:bg-gray-700" rows="2"></textarea></div>
                <div class="mb-3"><label class="text-xs">–î–µ–¥–ª–∞–π–Ω</label><input type="datetime-local" id="inpDeadline" class="w-full p-2 rounded border dark:bg-gray-700"></div>
                <div id="assigneeBlock" class="mb-3 hidden"><label class="text-xs">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label><select id="inpAssignee" class="w-full p-2 rounded border dark:bg-gray-700"></select></div>
                
                <div id="statusBlock" class="mb-4 hidden">
                    <label class="text-xs">–°—Ç–∞—Ç—É—Å</label>
                    <select id="inpStatus" class="w-full p-2 rounded border dark:bg-gray-700 mb-2">
                        <option value="todo">To Do</option><option value="in_progress">In Progress</option><option value="done">Done (–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫—É)</option>
                    </select>
                    
                    <div id="adminDisputeControls" class="hidden space-y-2 mt-2">
                        <div class="p-2 bg-red-100 dark:bg-red-900 rounded text-sm mb-2"><p class="font-bold">‚ö†Ô∏è –°–ø–æ—Ä:</p><p id="adminDisputeReason" class="italic">...</p></div>
                        <button type="button" onclick="resolveDispute('done')" class="w-full py-2 bg-green-600 text-white rounded">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
                        <button type="button" onclick="resolveDispute('in_progress')" class="w-full py-2 bg-gray-600 text-white rounded">üîí –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>

                    <button type="button" id="btnDispute" onclick="openDisputeInput()" class="w-full py-2 bg-red-500 text-white rounded hidden">üö© –û—Å–ø–æ—Ä–∏—Ç—å</button>
                    <div id="disputeInputArea" class="hidden mt-2">
                        <textarea id="inpDisputeReason" placeholder="–ü—Ä–∏—á–∏–Ω–∞..." class="w-full p-2 border rounded dark:bg-gray-700 text-sm"></textarea>
                        <button type="button" onclick="submitDispute()" class="w-full mt-1 py-1 bg-red-600 text-white rounded text-sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>

                <div class="flex gap-2 mt-6">
                    <button type="button" onclick="closeModal('modal')" class="flex-1 py-2 bg-gray-400/20 rounded">–ó–∞–∫—Ä—ã—Ç—å</button>
                    <button type="submit" id="btnSave" class="flex-1 py-2 bg-blue-600 text-white rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- News Modal -->
    <div id="newsModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 h-3/4 flex flex-col">
            <h2 class="text-xl font-bold mb-4">üì¢ –î–æ—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h2>
            
            <div id="adminNewsForm" class="hidden mb-4 border-b pb-4 dark:border-gray-600">
                <textarea id="newsContent" placeholder="–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ..." class="w-full p-2 border rounded dark:bg-gray-700 text-sm mb-2"></textarea>
                <button onclick="postNews()" class="w-full py-1 bg-blue-600 text-white rounded text-sm">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>

            <div id="newsList" class="flex-1 overflow-y-auto space-y-3"></div>
            <button onclick="closeModal('newsModal')" class="mt-4 w-full py-2 bg-gray-400/20 rounded">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- Users Modal -->
    <div id="usersModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 w-80 rounded-2xl p-6">
            <h2 class="text-xl font-bold mb-4">–†–æ–ª–∏</h2>
            <div id="usersListContent" class="space-y-2 max-h-96 overflow-y-auto"></div>
            <button onclick="closeModal('usersModal')" class="mt-4 w-full py-2 bg-gray-400/20 rounded">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        if (tg.colorScheme === 'dark') document.documentElement.classList.add('dark');
        const getHeaders = () => ({ 'Content-Type': 'application/json', 'X-Telegram-Init-Data': tg.initData });
        
        let currentUser = null, usersList = [], allTasks = [], isModalOpen = false;

        async function init() {
            try {
                const res = await fetch('/api/auth', { method: 'POST', headers: getHeaders(), body: JSON.stringify({ initData: tg.initData }) });
                currentUser = (await res.json()).user;
                document.getElementById('userRole').innerText = currentUser.role.toUpperCase();
                if (currentUser.role === 'owner') document.getElementById('usersBtn').classList.remove('hidden');
                if (['admin', 'owner'].includes(currentUser.role)) { 
                    document.getElementById('fab').classList.remove('hidden'); 
                    document.getElementById('filterContainer').classList.remove('hidden');
                    document.getElementById('adminNewsForm').classList.remove('hidden');
                }
                await loadUsers(); await loadTasks();
                setInterval(() => { if (!isModalOpen && !document.hidden) loadTasks(); }, 3000);
            } catch (e) { document.body.innerText = "Error auth: " + e.message; }
        }

        async function loadUsers() { 
            usersList = await (await fetch('/api/users', { headers: getHeaders() })).json(); 
            document.getElementById('inpAssignee').innerHTML = usersList.map(u => `<option value="${u.id}">${u.full_name}</option>`).join('');
            renderUsersModal();
        }

        async function loadTasks(filter = 'all') {
            const url = filter === 'mine' ? '/api/tasks?filter=mine' : '/api/tasks';
            allTasks = await (await fetch(url, { headers: getHeaders() })).json();
            const list = document.getElementById('taskList');
            if(!allTasks.length) { list.innerHTML = '<div class="text-center mt-10">–ù–µ—Ç –∑–∞–¥–∞—á</div>'; return; }
            list.innerHTML = allTasks.map(t => {
                const isLate = t.deadline && new Date(t.deadline) < new Date() && t.status !== 'done';
                const dateColor = isLate ? 'text-red-500 font-bold' : '';
                const lockIcon = t.is_locked ? 'üîí' : '';
                const disputeBorder = t.status === 'disputed' ? 'border-2 border-red-500' : 'border border-transparent';
                return `<div onclick="openEdit(${t.id})" class="card p-4 rounded-xl shadow-sm mb-2 cursor-pointer ${disputeBorder}"><div class="flex justify-between items-start"><h3 class="font-bold flex-1">${lockIcon} ${t.title}</h3><span class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded whitespace-nowrap">${t.status.replace('_',' ')}</span></div><div class="text-xs mt-2 flex justify-between text-gray-500"><span>üë§ ${t.assignee_name}</span><span class="${dateColor}">üìÖ ${t.deadline ? t.deadline.slice(0,16).replace('T', ' ') : '-'}</span></div></div>`;
            }).join('');
        }

        // News
        async function openNewsModal() {
            toggleModal('newsModal', true);
            const res = await fetch('/api/announcements', { headers: getHeaders() });
            const news = await res.json();
            document.getElementById('newsList').innerHTML = news.map(n => 
                `<div class="bg-gray-100 dark:bg-gray-700 p-3 rounded"><div class="text-xs text-gray-500 flex justify-between"><span>${n.author_name}</span><span>${n.created_at.slice(0,10)}</span></div><p class="mt-1 text-sm whitespace-pre-wrap">${n.content}</p></div>`
            ).join('');
        }
        async function postNews() {
            const content = document.getElementById('newsContent').value;
            if(!content) return;
            await fetch('/api/announcements', { method: 'POST', headers: getHeaders(), body: JSON.stringify({ content }) });
            document.getElementById('newsContent').value = '';
            openNewsModal();
        }

        function openModal() {
            currentEditingId = null; document.getElementById('taskForm').reset();
            document.getElementById('modalTitle').innerText = "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞";
            setupModalUI(true, false); toggleModal('modal', true);
        }

        function openEdit(id) {
            currentEditingId = id; const t = allTasks.find(x => x.id === id); if(!t) return;
            document.getElementById('modalTitle').innerText = t.title;
            document.getElementById('inpTitle').value = t.title; document.getElementById('inpDesc').value = t.description || "";
            document.getElementById('inpStatus').value = t.status;
            if(t.deadline) document.getElementById('inpDeadline').value = t.deadline.slice(0,16);
            
            const isOwner = currentUser.role === 'owner';
            const isDisputed = t.status === 'disputed';
            setupModalUI(false, t.is_locked);

            document.getElementById('adminDisputeControls').classList.add('hidden');
            document.getElementById('btnDispute').classList.add('hidden');
            document.getElementById('disputeInputArea').classList.add('hidden');
            document.getElementById('btnSave').classList.remove('hidden');

            if (isDisputed) {
                if (isOwner) {
                    document.getElementById('adminDisputeControls').classList.remove('hidden');
                    document.getElementById('adminDisputeReason').innerText = t.dispute_reason;
                    document.getElementById('btnSave').classList.add('hidden');
                    document.getElementById('inpStatus').disabled = true;
                } else {
                    document.getElementById('btnSave').classList.add('hidden');
                    document.getElementById('inpStatus').disabled = true;
                }
            } else {
                if (currentUser.role === 'worker' && t.is_mine && !t.is_locked && t.status !== 'done') {
                    document.getElementById('btnDispute').classList.remove('hidden');
                }
            }
            toggleModal('modal', true);
        }

        function setupModalUI(isNew, isLocked) {
            const isAdmin = ['admin', 'owner'].includes(currentUser.role);
            document.getElementById('statusBlock').classList.toggle('hidden', isNew);
            document.getElementById('assigneeBlock').classList.toggle('hidden', !isAdmin);
            ['inpTitle', 'inpDesc', 'inpDeadline'].forEach(id => document.getElementById(id).disabled = (!isAdmin && !isNew) || isLocked);
            document.getElementById('inpAssignee').disabled = !isAdmin && !isNew;
            document.getElementById('inpStatus').disabled = false; 
        }

        function openDisputeInput() { document.getElementById('btnDispute').classList.add('hidden'); document.getElementById('disputeInputArea').classList.remove('hidden'); document.getElementById('btnSave').classList.add('hidden'); }
        async function submitDispute() {
            const r = document.getElementById('inpDisputeReason').value; if(!r) return;
            await fetch(`/api/tasks/${currentEditingId}`, { method: 'PATCH', headers: getHeaders(), body: JSON.stringify({ status: 'disputed', dispute_reason: r }) });
            closeModal('modal'); loadTasks();
        }
        async function resolveDispute(s) { await fetch(`/api/tasks/${currentEditingId}`, { method: 'PATCH', headers: getHeaders(), body: JSON.stringify({ status: s }) }); closeModal('modal'); loadTasks(); }

        window.handleFormSubmit = async (e) => {
            e.preventDefault();
            const dVal = document.getElementById('inpDeadline').value;
            const body = {
                title: document.getElementById('inpTitle').value, description: document.getElementById('inpDesc').value,
                deadline: dVal ? dVal : null, assignee_id: parseInt(document.getElementById('inpAssignee').value),
                status: document.getElementById('inpStatus').value
            };
            const url = currentEditingId ? `/api/tasks/${currentEditingId}` : '/api/tasks';
            const res = await fetch(url, { method: currentEditingId ? 'PATCH' : 'POST', headers: getHeaders(), body: JSON.stringify(body) });
            if(res.ok) { closeModal('modal'); loadTasks(); } else alert("–û—à–∏–±–∫–∞");
        }

        function openUsersModal() { renderUsersModal(); toggleModal('usersModal', true); }
        function renderUsersModal() { document.getElementById('usersListContent').innerHTML = usersList.map(u => u.role==='owner'?'':`<div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded mb-2"><div class="text-sm truncate w-24">${u.full_name}</div><select onchange="changeRole(${u.id}, this.value)" class="text-xs p-1 rounded border dark:bg-gray-600"><option value="worker" ${u.role==='worker'?'selected':''}>Worker</option><option value="admin" ${u.role==='admin'?'selected':''}>Admin</option></select></div>`).join(''); }
        async function changeRole(uid, r) { await fetch(`/api/users/${uid}/role`, { method: 'PATCH', headers: getHeaders(), body: JSON.stringify({ role: r }) }); await loadUsers(); }
        
        function toggleModal(id, show) {
            const m = document.getElementById(id);
            if(show) { m.classList.remove('hidden'); setTimeout(() => m.classList.remove('opacity-0'), 10); if(id==='modal') isModalOpen=true; } 
            else { m.classList.add('opacity-0'); setTimeout(() => m.classList.add('hidden'), 300); if(id==='modal') isModalOpen=false; }
            if(id === 'modal') document.getElementById('modalContent').classList.toggle('translate-y-full', !show);
        }
        window.closeModal = (id) => toggleModal(id, false);
        init();
    </script>
</body>
</html>
